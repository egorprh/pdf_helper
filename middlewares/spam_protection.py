import time
from collections import defaultdict, deque
from typing import Callable, Dict, Any
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from aiogram import Bot
import logging

logger = logging.getLogger(__name__)


class AntiSpamMiddleware(BaseMiddleware):
    def __init__(self, bot: Bot, limit=5, interval=2, block_duration=30):
        super().__init__()
        self.bot = bot
        self.limit = limit
        self.interval = interval
        self.block_duration = block_duration
        self.user_spam_tracker: Dict[int, deque] = defaultdict(deque)
        self.user_blocked_until: Dict[int, float] = {}

    async def __call__(
            self,
            handler: Callable[[TelegramObject, Dict[str, Any]], Any],
            event: TelegramObject,
            data: Dict[str, Any]
    ) -> Any:
        # –ù–∞ —É—Ä–æ–≤–Ω–µ dp.update event –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∏–ø–æ–º Update –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å from_user.
        # Aiogram –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ data –∫–ª—é—á–∏ event_from_user / event_chat —á–µ—Ä–µ–∑ UserContextMiddleware.
        user = data.get("event_from_user") or getattr(event, "from_user", None)
        if not user:
            return await handler(event, data)

        now = time.time()
        uid = user.id

        if uid in self.user_blocked_until and now < self.user_blocked_until[uid]:
            logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} {user.id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ —Å–ø–∞–º")
            await self.bot.send_message(uid, "üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —Å–ø–∞–º—å—Ç–µ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥.")
            return

        timestamps = self.user_spam_tracker[uid]
        timestamps.append(now)

        while timestamps and now - timestamps[0] > self.interval:
            timestamps.popleft()

        if len(timestamps) > self.limit:
            self.user_blocked_until[uid] = now + self.block_duration
            self.user_spam_tracker[uid].clear()
            logger.warning(f"üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ —Å–ø–∞–º")
            await self.bot.send_message(uid, "üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —Å–ø–∞–º—å—Ç–µ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥.")
            return

        return await handler(event, data)
